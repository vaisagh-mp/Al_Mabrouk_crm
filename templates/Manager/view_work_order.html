{% extends 'Manager/managerbase.html' %}
{% load static %}
{% block content %}

<style>
  .wo-table,
  .wo-table th,
  .wo-table td {
    border: 1px solid black;
    border-collapse: collapse;
    padding: 6px;
    font-size: 14px;
    color: rgb(48, 47, 47);
  }

  .wo-section {
    margin-bottom: 25px;
  }

  .wo-title {
    font-weight: bold;
    margin-bottom: 8px;
  }
  .work_order_btn .wrp{
    padding: 10px 15px;
    background-color: var(--secondary-bg);
    color: #ffffff;
    border: none;
    border-radius: 5px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  .work_order_btn  .wrp:hover {
  background-color: #0056b3;
}

.wo-section pre {
  white-space: nowrap;
  margin: 0;
  padding: 0;
  line-height: 1.5; 
}
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div class="pg-title">
    <h1>Work Order Sheet</h1>
  </div>

  <div class="d-flex gap-2">
      <a href="{% url 'download-work-order-pdf' work_order.id %}" class="btn btn-outline-primary">
        <i class="bi bi-file-earmark-pdf-fill"></i> PDF
      </a>

      <a href="{% url 'manager-update-work-order' work_order.id %}" class="btn btn-outline-success">
        <i class="bi bi-pencil-square"></i> Edit
      </a>
  </div>
</div>



<div class="widget-box table-wdgt">

  <!-- Main Work Order Info -->
  <table class="wo-table" style="width: 100%; margin-bottom: 30px;">
    <tr>
      <td><strong>Work Order Number:</strong> {{ work_order.work_order_number }}</td>
      <td><strong>Vessel:</strong> {{ work_order.vessel }}</td>
    </tr>
    <tr>
      <td><strong>CLIENT:</strong> {{ work_order.client }}</td>
      <td><strong>IMO No:</strong> {{ work_order.imo_no }}</td>
    </tr>
    <tr>
      <td><strong>Location:</strong> {{ work_order.location }}</td>
      <td><strong>ASSIGNED DATE:</strong> {{ work_order.assigned_date }}</td>
    </tr>
  </table>

  <!-- Job Scope & Assignment -->
  <div class="wo-section">
    <div class="wo-title">JOB SCOPE:</div>
    <div>{{ work_order.job_scope }}</div>
  </div>

  <div class="wo-section">
    <div class="wo-title">JOB ASSIGNED TO (Live Members):</div>
    <ul>
      {% for user in live_members %}
        <li>{{ user.get_full_name|default:user.username }}</li>
      {% empty %}
        <li>No live team members assigned.</li>
      {% endfor %}
    </ul>
  </div>

  <div class="wo-section">
    <div class="wo-title">JOB ASSIGNED TO (All Members):</div>
    <ul>
      {% for user in all_members %}
        <li>{{ user.get_full_name|default:user.username }}</li>
      {% empty %}
        <li>No one assigned.</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Work Details Table -->
  <table class="wo-table" style="width: 100%; margin-bottom: 30px;">
      <tr>
          <th>WORK DETAILS:</th>
          <td colspan="3">{{ work_order.job_scope }}</td>
      </tr>
      <tr>
          <th>START DATE:</th>
          <td colspan="3">{{ work_order_detail.start_date }}</td>
      </tr>
      <tr>
          <th>COMPLETION DATE:</th>
          <td colspan="3">{{ work_order_detail.completion_date|default:"--/--/--" }}</td>
      </tr>
      <tr>
          <th>ESTIMATED HOURS:</th>
          <td colspan="3">{{ work_order_detail.estimated_hours|default:"0" }} hours</td>
      </tr>
    
      <tr>
          <th>TOTAL HOURS:</th>
          <td colspan="3">{{ calculated_hours|floatformat:2 }} hours</td>
      </tr>
    
    
    
      <tr>
      <th>Date</th>
      <th colspan="2">START TIME(s)</th>
      <th colspan="2">FINISH TIME(s)</th>
      </tr>
      {% for t in work_order.times.all %}
      <tr>
          <td>{{ t.date|date:"d/m/Y" }}</td>
          <td colspan="2">{{ t.start_time|default:"00:00" }}</td>
          <td colspan="2">{{ t.finish_time|default:"00:00" }}</td>
      </tr>
      {% empty %}
      <tr>
          <td colspan="5">No time entries</td>
      </tr>
      {% endfor %}
    
      </table>
  <!-- Job Instructions -->
  <div class="wo-section">
    <div class="wo-title">JOB INSTRUCTIONS:</div>
    {{ work_order.job_instructions | safe }}
  </div>

  <!-- Spares Required Table -->
  <div class="wo-section">
    <div class="wo-title">SPARES REQUIRED</div>
    <table class="wo-table" style="width: 100%;">
      <tr>
        <th>NAME</th>
        <th>UNIT</th>
        <th>QTY</th>
      </tr>
      {% for spare in work_order.spares.all %}
      <tr>
        <td>{{ spare.name }}</td>
        <td>{{ spare.unit }}</td>
        <td>{{ spare.quantity }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>

  <!-- Spares Consumed Table -->
<div class="wo-section">
  <div class="wo-title">SPARES CONSUMED</div>

  <table class="wo-table" style="width: 100%;">
    <tr>
      <th>NAME</th>
      <th>UNIT</th>
      <th>QTY</th>
    </tr>

    {% for spare in work_order.consumed_spares.all %}
      <tr>
        <td>{{ spare.name }}</td>
        <td>{{ spare.unit }}</td>
        <td>{{ spare.quantity }}</td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="3">No spares consumed.</td>
      </tr>
    {% endfor %}
  </table>
</div>


  <!-- Tools Required Table -->
  <div class="wo-section">
    <div class="wo-title">Tools Required</div>
    <table class="wo-table" style="width: 100%;">
      <tr>
        <th>Tools Name</th>
        <th>Quantity</th>
      </tr>
      {% for tool in work_order.tools.all %}
      <tr>
        <td>{{ tool.name }}</td>
        <td>{{ tool.quantity }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>

  <!-- Documents Table -->
  <div class="wo-section">
    <div class="wo-title">Documents</div>
    <table class="wo-table" style="width: 100%;">
      <tr>
        <th>Docs Name</th>
        <th>Status</th>
      </tr>
      {% for doc in work_order.documents.all %}
      <tr>
        <td>{{ doc.name }}</td>
        <td>{{ doc.status }}</td>
      </tr>
      {% endfor %}
    </table>
  </div>

  <!-- Project Description -->
  <div class="wo-section">
    <div class="wo-title">PROJECT DESCRIPTION:</div>
    <div>{{ work_order.project_description|linebreaks }}</div>
  </div>

  <!-- Project Image -->
  <!-- {% if work_order.images.exists %}
    <div class="wo-section">
      <div class="wo-title">PROJECT IMAGE:</div>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        {% for img in work_order.images.all %}
          <img src="{{ img.image.url }}" alt="Project Image" style="width: 200px; height: auto;" />
        {% endfor %}
      </div>
  {% else %}
    <p>No images uploaded.</p>
  {% endif %} -->

  {% if work_order.images.exists %}
  <div class="wo-section">
    <div class="wo-title">PROJECT IMAGES:</div>

    {% regroup work_order.images.all by name as image_groups %}

    {% for group in image_groups %}
      <div style="margin-bottom: 30px;">

        <!-- Group Heading -->
        <h4 style="margin-bottom: 5px;">
          {{ group.grouper }}
        </h4>

        <!-- Group Description -->
        {% with first_image=group.list.0 %}
          {% if first_image.description %}
            <div style="font-size: 13px; color: #555; margin-bottom: 12px;">
              {{ first_image.description }}
            </div>
          {% endif %}
        {% endwith %}

        <!-- Images -->
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
          {% for img in group.list %}
            <img
              src="{{ img.image.url }}"
              alt="{{ img.name }}"
              style="
                width: 200px;
                height: auto;
                border: 1px solid #ccc;
                padding: 5px;
              "
            />
          {% endfor %}
        </div>

      </div>
    {% endfor %}
  </div>
{% else %}
  <p>No images uploaded.</p>
{% endif %}


  <div class="mt-4 work_order_btn">
    <a href="{% url 'project-summary-view' work_order.project.id %}" class="btn wrp">Back to Project</a>
  </div>
</div>

{% endblock %}