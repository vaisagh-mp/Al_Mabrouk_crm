{% extends "Admin/adminbase.html" %}
{% load static %}
{% block content %}

<div class="pg-title">
    <h1>Project Analytics</h1>
</div>

<!-- ================= DATE FILTER ================= -->
<!-- <form method="get" class="date-filter mb-20">
    <input
        type="text"
        id="datePicker"
        name="date"
        placeholder="Select date / range"
        value="{{ start_date }}{% if end_date and start_date != end_date %} to {{ end_date }}{% endif %}"
        style="width: 260px;"
        required
    >
    <button type="submit" class="prmry-btn">Filter</button>
</form> -->
<div class="kpi-box">
    <div class="row rg-24">

        <div class="col-lg-2 col-6 col-md-4">
            <div class="kpi-card">
                <div class="kpi-icon bg-blue">
                    <i class="fas fa-briefcase"></i>
                </div>
                <div class="kpi-content">
                    <h3>{{ kpi_total_projects }}</h3>
                    <span>Projects</span>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-6 col-md-4">
            <div class="kpi-card">
                <div class="kpi-icon bg-indigo">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="kpi-content">
                    <h3>{{ kpi_total_hours|floatformat:2 }}</h3>
                    <span>Work Hours</span>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-6 col-md-4">
            <div class="kpi-card">
                <div class="kpi-icon bg-orange">
                    <i class="fas fa-user-tie"></i>
                </div>
                <div class="kpi-content">
                    <h3>{{ kpi_employee_cost|floatformat:2 }}</h3>
                    <span>Emp Cost</span>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-6 col-md-4">
            <div class="kpi-card">
                <div class="kpi-icon bg-green">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="kpi-content">
                    <h3>{{ kpi_revenue|floatformat:2 }}</h3>
                    <span>Revenue</span>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-6 col-md-4">
            <div class="kpi-card">
                <div class="kpi-icon bg-success">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="kpi-content">
                    <h3>{{ kpi_profit|floatformat:2 }}</h3>
                    <span>Profit</span>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-6 col-md-4">
            <div class="kpi-card">
                <div class="kpi-icon bg-red">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="kpi-content">
                    <h3>{{ kpi_expense|floatformat:2 }}</h3>
                    <span>Expense</span>
                </div>
            </div>
        </div>

    </div>
</div>


<!-- ================= ANALYTICS GRAPHS ================= -->
<div class="widget-box mb-30">

    <div class="table-header-inline">
        <h4>Projects & Revenue Trend</h4>

        <form method="get" id="chartFilterForm" class="sort-form">
            <div class="sort-wrapper">
                <label for="rangeSelect">View</label>
            
                <div class="select-box">
                    <select id="rangeSelect" name="range" onchange="this.form.submit()">
                        <option value="day" {% if range == "day" %}selected{% endif %}>
                            üìÖ Day
                        </option>
                        <option value="week" {% if range == "week" %}selected{% endif %}>
                            üóì Week
                        </option>
                        <option value="month" {% if range == "month" %}selected{% endif %}>
                            üìÜ Month
                        </option>
                        <option value="year" {% if range == "year" %}selected{% endif %}>
                            üè∑ Year
                        </option>
                    </select>
                    <span class="select-arrow">‚ñæ</span>
                </div>
            </div>
        </form>

    </div>

    <div class="row rg-30">
        <div class="col-md-6">
            <canvas id="projectsChart" height="120"></canvas>
        </div>

        <div class="col-md-6">
            <canvas id="revenueChart" height="120"></canvas>
        </div>
    </div>

</div>



    <!-- ================= TOP TABLES ================= -->
    <div class="row rg-30 mt-30">

    <!-- TOP 5 PROJECTS -->
     
        <div class="col-md-6">
            <div class="widget-box">
        <div class="table-header-inline">
            <h4>Projects by Profit</h4>

            <form method="get" class="sort-form">
                <input type="hidden" name="page" value="{{ projects_page.number }}">
                <div class="sort-wrapper">
    <label for="sortSelect">Sort by Profit</label>

    <div class="select-box">
        <select id="sortSelect" name="sort" onchange="this.form.submit()">
            <option value="desc" {% if sort == "desc" %}selected{% endif %}>
                ‚¨Ü High ‚Üí Low
            </option>
            <option value="asc" {% if sort == "asc" %}selected{% endif %}>
                ‚¨á Low ‚Üí High
            </option>
        </select>
        <span class="select-arrow">‚ñæ</span>
    </div>
</div>

            </form>

        </div>

        <div class="table-wdgt">
            <table class="widget-box-table">
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Expense</th>
                        <th>Profit</th>
                        <th>Profit %</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in projects_page %}
                    <tr>
                        <td>
                            <a href="javascript:void(0)"
                               class="open-project-modal"
                               data-project="{{ p.project.id }}"
                               data-project-name="{{ p.project.name }}"
                               data-profit="{{ p.profit|floatformat:2 }}"
                               data-profit-percent="{{ p.profit_percent|floatformat:2 }}">
                                {{ p.project.name }}
                            </a>
                        </td>
                        <td>{{ p.expense|floatformat:2 }}</td>
                        <td>{{ p.profit|floatformat:2 }}</td>
                        <td>{{ p.profit_percent|floatformat:2 }}%</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" align="center">No projects found</td>
                    </tr>
                    {% endfor %}
                    </tbody>
            </table>
            <div class="pagination mt-10">

                {% if projects_page.has_previous %}
                    <a href="?page={{ projects_page.previous_page_number }}&sort={{ sort }}">
                        ‚Üê Prev
                    </a>
                {% endif %}
                
                <span>
                    Page {{ projects_page.number }} of {{ projects_page.paginator.num_pages }}
                </span>
            
                {% if projects_page.has_next %}
                    <a href="?page={{ projects_page.next_page_number }}&sort={{ sort }}">
                        Next ‚Üí
                    </a>
                {% endif %}
                
            </div>

        </div>
    </div>
        </div>
    

    <!-- TOP CLIENTS -->
     
    <div class="col-md-6">
        <div class="widget-box">
        <h4>Top 5 Clients</h4>
        <div class="table-wdgt">
            <table class="widget-box-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>No. of Projects</th>
                        <th>Total Profit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in top_clients %}
                    <tr>
                        <td>{{ client.name|default:"N/A" }}</td>
                        <td>{{ client.projects }}</td>
                        <td>
                            {{client.profit|floatformat:2}}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" align="center">No client data</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    </div>
    </div>





<!-- ================= PROJECT DRILL DOWN MODAL ================= -->
<div class="modal fade" id="projectAnalyticsModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content crm-modal">

      <!-- HEADER -->
      <div class="modal-header crm-modal-header">
        <div>
          <h4 class="modal-title" id="modalProjectTitle"></h4>
          <div class="modal-subtitle">
            <span class="badge badge-profit">
              Profit: <span id="modalProfit"></span>
            </span>
            <span class="badge badge-percent">
              <span id="modalProfitPercent"></span>% Margin
            </span>
          </div>
        </div>

        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- BODY -->
      <div class="modal-body">

        <!-- KPI STRIP -->
        <div class="modal-kpis">
          <div class="kpi-mini">
            <span>Total Employees</span>
            <strong id="modalEmployeeCount">‚Äì</strong>
          </div>
          <div class="kpi-mini">
            <span>Total Hours</span>
            <strong id="modalTotalHours">‚Äì</strong>
          </div>
          <div class="kpi-mini">
            <span>Total Cost</span>
            <strong id="modalTotalCost">‚Äì</strong>
          </div>
        </div>

        <!-- TABLE -->
        <div class="table-wdgt mt-20">
          <table class="widget-box-table crm-table">
            <thead>
              <tr>
                <th>Employee</th>
                <th>Hours</th>
                <th>OT</th>
                <th>Utilization</th>
                <th>Normal Cost</th>
                <th>OT Cost</th>
                <th>Total Cost</th>
              </tr>
            </thead>
            <tbody id="modalEmployeeTable">
              <tr>
                <td colspan="7" class="text-center text-muted">
                  Loading project analytics‚Ä¶
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>


<style>
    .pg-title h1{
        font-size: x-large;
    }
    .widget-box, .kpi-box{
        margin-bottom: 25px;
    }
    .status-wdgt h6, .status-wdgt p{
        color: #333333;
    }
    .status-wdgt h6{
        font-size: 28px;
    }
    .status-wdgt p{
        font-size: 15px;
    }
    .table-header-inline {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
}

.sort-form {
    display: flex;
    align-items: center;
    gap: 8px;
}

.sort-form label {
    font-size: 14px;
    margin: 0;
}
.sort-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.sort-wrapper label {
    font-weight: 500;
    color: #444;
}

.select-box {
    position: relative;
}

.select-box select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;

    padding: 6px 32px 6px 10px;
    border-radius: 6px;
    border: 1px solid #d0d5dd;
    background: #fff;
    font-size: 13px;
    cursor: pointer;
}

.select-box select:focus {
    outline: none;
    border-color: #3d6999;
}

.select-arrow {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    pointer-events: none;
    color: #666;
}
.sort-form {
    display: flex;
    align-items: center;
    gap: 10px;
}

.sort-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.sort-wrapper label {
    font-weight: 500;
    color: #444;
}

.select-box {
    position: relative;
}

.select-box select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;

    padding: 6px 34px 6px 12px;
    border-radius: 6px;
    border: 1px solid #d0d5dd;
    background: #fff;
    font-size: 13px;
    cursor: pointer;
    min-width: 120px;
}

.select-box select:hover {
    border-color: #3d6999;
}

.select-box select:focus {
    outline: none;
    border-color: #3d6999;
    box-shadow: 0 0 0 2px rgba(61,105,153,0.15);
}

.select-arrow {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    pointer-events: none;
    color: #666;
}
.kpi-box {
    margin-bottom: 30px;
}

.kpi-card {
    display: flex;
    align-items: center;
    gap: 14px;
    background: #fff;
    padding: 18px;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    transition: all 0.25s ease;
}

.kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 28px rgba(0,0,0,0.1);
}

.kpi-icon {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 18px;
}

.kpi-content h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #111827;
}

.kpi-content span {
    font-size: 10px;
    color: #6b7280;
    font-weight: 500;
}

.crm-modal {
    border-radius: 14px;
    overflow: hidden;
}

.crm-modal-header {
    background: #f8fafc;
    border-bottom: 1px solid #e5e7eb;
}

.modal-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 4px;
}

.modal-subtitle {
    display: flex;
    gap: 10px;
    font-size: 18px;
}

.modal-body .table-wdgt{
    /* overflow-x: unset !important; */
    padding: 30px 0 !important;
}
.badge {
    padding: 5px 10px;
    border-radius: 6px;
    font-weight: 600;
}

.badge-profit {
    background: #ecfdf5;
    color: #047857;
}

.badge-percent {
    background: #eff6ff;
    color: #1d4ed8;
}

/* KPI STRIP */
.modal-kpis {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
}

.kpi-mini {
    flex: 1;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 12px;
}

.kpi-mini span {
    display: block;
    font-size: 12px;
    color: #6b7280;
}

.kpi-mini strong {
    font-size: 18px;
    font-weight: 700;
    color: #111827;
}

/* TABLE */
.crm-table thead th {
    background: #f9fafb;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: .04em;
}

.crm-table tbody td {
    font-size: 14px;
}

.crm-table tbody tr:hover {
    background: #f8fafc;
}

.crm-table thead, .crm-table tr{
    height: 40px !important;
}


/* UTILIZATION COLOR */
.util-high { color: #16a34a; font-weight: 600; }
.util-mid { color: #f59e0b; font-weight: 600; }
.util-low { color: #dc2626; font-weight: 600; }


/* Color helpers */
.bg-blue { background: #3d6999; }
.bg-indigo { background: #6366f1; }
.bg-orange { background: #f59e0b; }
.bg-green { background: #16a34a; }
.bg-success { background: #059669; }
.bg-red { background: #dc2626; }


@media(max-width:991px){
    .kpi-card{
        margin-bottom: 20px;
    }
}
</style>


<!-- ================= FLATPICKR ================= -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>
document.addEventListener("DOMContentLoaded", function () {
    flatpickr("#datePicker", {
        mode: "range",
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d F Y",
        allowInput: true
    });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const modalEl = document.getElementById("projectAnalyticsModal");
    const modalInstance = new bootstrap.Modal(modalEl);

    document.querySelectorAll(".open-project-modal").forEach(link => {
        link.addEventListener("click", function () {

            const projectId = this.dataset.project;
            const projectName = this.dataset.projectName;
            const profit = this.dataset.profit;
            const profitPercent = this.dataset.profitPercent;

            // ---------- HEADER ----------
            document.getElementById("modalProjectTitle").innerText = projectName;
            document.getElementById("modalProfit").innerText = profit;
            document.getElementById("modalProfitPercent").innerText = profitPercent;

            // ---------- RESET KPI STRIP ----------
            document.getElementById("modalEmployeeCount").innerText = "‚Äì";
            document.getElementById("modalTotalHours").innerText = "‚Äì";
            document.getElementById("modalTotalCost").innerText = "‚Äì";

            // ---------- TABLE ----------
            const tableBody = document.getElementById("modalEmployeeTable");
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        Loading project analytics‚Ä¶
                    </td>
                </tr>
            `;

            fetch(`/service-logs/analytics/project/${projectId}/`)
                .then(res => {
                    if (!res.ok) throw new Error("Failed to load data");
                    return res.json();
                })
                .then(data => {

                    tableBody.innerHTML = "";

                    if (!data.length) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    No employee data available
                                </td>
                            </tr>
                        `;
                        return;
                    }

                    let totalHours = 0;
                    let totalCost = 0;

                    data.forEach(emp => {
                        totalHours += emp.hours;
                        totalCost += emp.total_cost;

                        let utilClass =
                            emp.utilization >= 80 ? "util-high" :
                            emp.utilization >= 50 ? "util-mid" :
                            "util-low";

                        tableBody.innerHTML += `
                            <tr>
                                <td>${emp.name}</td>
                                <td>${emp.hours.toFixed(2)}</td>
                                <td>${emp.ot.toFixed(2)}</td>
                                <td class="${utilClass}">
                                    ${emp.utilization}%
                                </td>
                                <td>${emp.normal_cost.toFixed(2)}</td>
                                <td>${emp.ot_cost.toFixed(2)}</td>
                                <td><strong>${emp.total_cost.toFixed(2)}</strong></td>
                            </tr>
                        `;
                    });

                    // ---------- UPDATE KPI STRIP ----------
                    document.getElementById("modalEmployeeCount").innerText = data.length;
                    document.getElementById("modalTotalHours").innerText = totalHours.toFixed(2);
                    document.getElementById("modalTotalCost").innerText = totalCost.toFixed(2);
                })
                .catch(err => {
                    console.error(err);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-danger">
                                Error loading project analytics
                            </td>
                        </tr>
                    `;
                });

            modalInstance.show();
        });
    });

});
</script>


<script>
const projectsCtx = document.getElementById("projectsChart").getContext("2d");

new Chart(projectsCtx, {
    type: "line",
    data: {
        labels: {{ labels|safe }},
        datasets: [
            {
                label: "Projects (Current)",
                data: {{ projects_current|safe }},
                borderColor: "#3d6999",
                backgroundColor: "rgba(61,105,153,0.1)",
                tension: 0.4,
                fill: true
            },
            {
                label: "Projects (Last Year)",
                data: {{ projects_last_year|safe }},
                borderColor: "#a0aec0",
                borderDash: [5, 5],
                tension: 0.4
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: "bottom" }
        }
    }
});
</script>

<script>
const revenueCtx = document.getElementById("revenueChart").getContext("2d");

new Chart(revenueCtx, {
    type: "line",
    data: {
        labels: {{ labels|safe }},
        datasets: [
            {
                label: "Revenue (Current)",
                data: {{ revenue_current|safe }},
                borderColor: "#16a34a",
                backgroundColor: "rgba(22,163,74,0.12)",
                tension: 0.4,
                fill: true
            },
            {
                label: "Revenue (Last Year)",
                data: {{ revenue_last_year|safe }},
                borderColor: "#9ca3af",
                borderDash: [5, 5],
                tension: 0.4
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: "bottom" }
        }
    }
});
</script>

{% endblock %}
